<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Mapa de Postes</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css"
    />
    <style>
      html,
      body {
        margin: 0;
        padding: 0;
        height: 100%;
      }
      #map {
        height: 100vh;
        width: 100vw;
      }
      .painel-busca {
        position: absolute;
        z-index: 1000;
        background: white;
        padding: 10px;
        border-radius: 8px;
        top: 30px;
        right: 20px;
        width: 260px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
        font-family: sans-serif;
      }
      .painel-busca input {
        margin-bottom: 5px;
        width: 100%;
        padding: 5px;
        display: block;
      }
      .painel-busca button {
        margin-top: 5px;
        margin-right: 5px;
        padding: 5px 10px;
      }
      .legenda {
        position: absolute;
        bottom: 10px;
        right: 10px;
        background: white;
        padding: 10px;
        border-radius: 8px;
        font-family: sans-serif;
        font-size: 14px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
      }
      .legenda-item {
        display: flex;
        align-items: center;
        margin-bottom: 5px;
      }
      .bolinha {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-right: 8px;
        border: 1px solid #555;
      }
    </style>
  </head>
  <body>
    <div class="painel-busca">
      <input type="text" id="busca-id" placeholder="Buscar por ID do poste" />
      <input type="text" id="busca-coord" placeholder="Latitude,Longitude" />
      <input
        type="text"
        id="filtro-empresa"
        list="lista-empresas"
        placeholder="Filtrar por empresa"
      />
      <datalist id="lista-empresas"></datalist>
      <input type="text" id="busca-rua" placeholder="Buscar por rua" />
      <button onclick="buscarID()">üîç ID</button>
      <button onclick="buscarCoordenada()">üìç Coordenada</button>
      <button onclick="filtrarEmpresa()">üè¢ Filtrar</button>
      <button onclick="resetarMapa()">üîÑ Mostrar tudo</button>
      <button onclick="buscarPorRua()">üõ£ Rua</button>
      <button onclick="limparBusca()">üßπ Limpar</button>
      <div id="resumo-rua" style="margin-top: 10px; font-size: 14px"></div>
    </div>

    <div class="legenda">
      <div class="legenda-item">
        <div class="bolinha" style="background: green"></div>
        At√© 5 empresas
      </div>
      <div class="legenda-item">
        <div class="bolinha" style="background: red"></div>
        Mais de 5 empresas
      </div>
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
    <script>
      const map = L.map("map").setView([-23.2, -45.9], 12);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(
        map
      );

      const markers = L.markerClusterGroup({
        spiderfyOnMaxZoom: true,
        showCoverageOnHover: false,
        zoomToBoundsOnClick: false,
        maxClusterRadius: 60,
        disableClusteringAtZoom: 17,
      });

      markers.on("clusterclick", (a) => a.layer.spiderfy());

      const todosPostes = [];
      const empresasContagem = {};

      fetch("/api/postes")
        .then((res) => res.json())
        .then((data) => {
          data.forEach((poste) => {
            if (!poste.coordenadas) return;
            const [lat, lon] = poste.coordenadas.split(",").map(Number);
            if (isNaN(lat) || isNaN(lon)) return;

            const empresas = poste.empresas.split(",").map((e) => e.trim());
            empresas.forEach((empresa) => {
              if (!empresasContagem[empresa]) empresasContagem[empresa] = 0;
              empresasContagem[empresa]++;
            });

            const qtdEmpresas = empresas.length;
            const cor = qtdEmpresas >= 5 ? "red" : "green";

            const icone = L.divIcon({
              className: "",
              html: `<div style="width:14px;height:14px;border-radius:50%;background:${cor};border:2px solid white;"></div>`,
              iconSize: [16, 16],
              iconAnchor: [8, 8],
            });

            const marker = L.marker([lat, lon], { icon: icone });
            marker.bindPopup(
              `<b>ID do Poste:</b> ${poste.id_poste}<br><b>Empresas:</b> ${poste.empresas}`
            );
            marker.bindTooltip(
              `ID: ${poste.id_poste} ‚Ä¢ ${qtdEmpresas} empresa(s)`,
              { direction: "top" }
            );
            markers.addLayer(marker);

            todosPostes.push({ ...poste, lat, lon });
          });

          map.addLayer(markers);
          preencherAutocomplete();
        });

      function preencherAutocomplete() {
        const lista = document.getElementById("lista-empresas");
        lista.innerHTML = "";
        Object.keys(empresasContagem)
          .sort()
          .forEach((empresa) => {
            const option = document.createElement("option");
            option.value = empresa;
            option.label = `${empresa} (${empresasContagem[empresa]} postes)`;
            lista.appendChild(option);
          });
      }

      function buscarID() {
        const id = document.getElementById("busca-id").value.trim();
        const resultado = todosPostes.find((p) => p.id_poste.toString() === id);
        if (resultado) {
          map.setView([resultado.lat, resultado.lon], 18);
          L.popup()
            .setLatLng([resultado.lat, resultado.lon])
            .setContent(
              `<b>ID:</b> ${resultado.id_poste}<br><b>Empresas:</b> ${resultado.empresas}`
            )
            .openOn(map);
        } else {
          alert("Poste n√£o encontrado.");
        }
      }

      function buscarCoordenada() {
        const coordInput = document.getElementById("busca-coord").value.trim();
        const partes = coordInput.split(",");
        if (partes.length !== 2) return alert("Use o formato: lat,lon");
        const lat = parseFloat(partes[0]);
        const lon = parseFloat(partes[1]);
        if (isNaN(lat) || isNaN(lon)) return alert("Coordenadas inv√°lidas.");

        map.setView([lat, lon], 18);
        L.popup()
          .setLatLng([lat, lon])
          .setContent(`<b>Coordenada:</b><br>${lat}, ${lon}`)
          .openOn(map);
      }

      function filtrarEmpresa() {
        const termo = document
          .getElementById("filtro-empresa")
          .value.trim()
          .toLowerCase();
        if (!termo) return;
        markers.clearLayers();

        todosPostes.forEach((poste) => {
          if (!poste.empresas.toLowerCase().includes(termo)) return;
          const qtdEmpresas = poste.empresas.split(",").length;
          const cor = qtdEmpresas >= 5 ? "red" : "green";

          const icone = L.divIcon({
            className: "",
            html: `<div style="width:14px;height:14px;border-radius:50%;background:${cor};border:2px solid white;"></div>`,
          });

          const marker = L.marker([poste.lat, poste.lon], { icon: icone });
          marker.bindPopup(
            `<b>ID do Poste:</b> ${poste.id_poste}<br><b>Empresas:</b> ${poste.empresas}`
          );
          marker.bindTooltip(
            `ID: ${poste.id_poste} ‚Ä¢ ${qtdEmpresas} empresa(s)`,
            { direction: "top" }
          );
          markers.addLayer(marker);
        });
      }

      function resetarMapa() {
        markers.clearLayers();
        todosPostes.forEach((poste) => {
          const qtdEmpresas = poste.empresas.split(",").length;
          const cor = qtdEmpresas >= 5 ? "red" : "green";

          const icone = L.divIcon({
            className: "",
            html: `<div style="width:14px;height:14px;border-radius:50%;background:${cor};border:2px solid white;"></div>`,
          });

          const marker = L.marker([poste.lat, poste.lon], { icon: icone });
          marker.bindPopup(
            `<b>ID do Poste:</b> ${poste.id_poste}<br><b>Empresas:</b> ${poste.empresas}`
          );
          marker.bindTooltip(
            `ID: ${poste.id_poste} ‚Ä¢ ${qtdEmpresas} empresa(s)`,
            { direction: "top" }
          );
          markers.addLayer(marker);
        });
      }

      function limparBusca() {
        document.getElementById("busca-id").value = "";
        document.getElementById("busca-coord").value = "";
        document.getElementById("filtro-empresa").value = "";
        document.getElementById("busca-rua").value = "";
        document.getElementById("resumo-rua").innerHTML = "";
        resetarMapa();
      }

      async function buscarPorRua() {
        const rua = document.getElementById("busca-rua").value.trim();
        const resumoDiv = document.getElementById("resumo-rua");
        resumoDiv.innerHTML = "";

        if (!rua) {
          resumoDiv.innerHTML =
            "<span style='color:red;'>Digite o nome da rua.</span>";
          return;
        }

        try {
          const response = await fetch(
            `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(
              rua
            )}, S√£o Jos√© dos Campos, Brasil&limit=1`,
            {
              headers: {
                "User-Agent": "poste-mapa-app",
              },
            }
          );

          const resultados = await response.json();

          if (!resultados.length) {
            resumoDiv.innerHTML = `<span style='color:red;'>Rua n√£o encontrada: <b>${rua}</b></span>`;
            return;
          }

          const { lat, lon, display_name } = resultados[0];
          map.setView([parseFloat(lat), parseFloat(lon)], 17);

          resumoDiv.innerHTML = `
            <b>Centralizado na rua:</b> ${display_name}<br>
            Coordenadas aproximadas: ${lat}, ${lon}<br>
            <i>Verifique visualmente os postes no mapa.</i>
          `;
        } catch (error) {
          console.error("Erro ao buscar rua:", error);
          resumoDiv.innerHTML =
            "<span style='color:red;'>Erro ao buscar rua. Tente novamente.</span>";
        }
      }
    </script>
  </body>
</html>

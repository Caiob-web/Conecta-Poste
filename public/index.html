<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Mapa de Postes</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
    <style>
      html, body {
        margin: 0;
        padding: 0;
        height: 100%;
      }
      #map {
        height: 100vh;
        width: 100vw;
      }
      .painel-busca {
        position: absolute;
        top: 10px;
        right: 10px; /* MUDAN√áA: agora o painel est√° √† direita */
        z-index: 1000;
        background: white;
        padding: 10px;
        border-radius: 8px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
        font-family: sans-serif;
      }
      .painel-busca input {
        margin-bottom: 5px;
        width: 200px;
        padding: 5px;
        display: block;
      }
      .painel-busca button {
        margin-top: 5px;
        margin-right: 5px;
        padding: 5px 10px;
      }
      .legenda {
        position: absolute;
        bottom: 10px;
        right: 10px;
        background: white;
        padding: 10px;
        border-radius: 8px;
        font-family: sans-serif;
        font-size: 14px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
      }
      .legenda-item {
        display: flex;
        align-items: center;
        margin-bottom: 5px;
      }
      .bolinha {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-right: 8px;
        border: 1px solid #555;
      }
      .botao-topo {
        position: absolute;
        right: 10px;
        z-index: 1001;
        padding: 5px 10px;
        border-radius: 6px;
        border: none;
        font-family: sans-serif;
        cursor: pointer;
        box-shadow: 0 0 6px rgba(0,0,0,0.2);
      }
      #togglePainel { top: 10px; }
      #localizacaoUsuario { top: 50px; }
    </style>
  </head>
  <body>
    <button id="togglePainel" class="botao-topo">üôà Esconder Painel</button>
    <button id="localizacaoUsuario" class="botao-topo">üìç Minha Localiza√ß√£o</button>

    <div class="painel-busca" id="painelBusca">
      <input type="text" id="busca-id" placeholder="Buscar por ID do poste" />
      <input type="text" id="busca-coord" placeholder="Latitude,Longitude" />
      <input type="text" id="filtro-empresa" list="lista-empresas" placeholder="Filtrar por empresa" />
      <datalist id="lista-empresas"></datalist>
      <input type="text" id="busca-rua" placeholder="Buscar por rua" />
      <button onclick="buscarID()">üîç ID</button>
      <button onclick="buscarCoordenada()">üìç Coordenada</button>
      <button onclick="filtrarEmpresa()">üè¢ Filtrar</button>
      <button onclick="buscarPorRua()">üõ£ Rua</button>
      <button onclick="resetarMapa()">üîÑ Mostrar tudo</button>
    </div>

    <div class="legenda">
      <div class="legenda-item">
        <div class="bolinha" style="background: green"></div>
        At√© 5 empresas
      </div>
      <div class="legenda-item">
        <div class="bolinha" style="background: red"></div>
        Mais de 5 empresas
      </div>
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
    <script>
      const map = L.map("map").setView([-23.2, -45.9], 12);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

      const markers = L.markerClusterGroup({
        spiderfyOnMaxZoom: true,
        showCoverageOnHover: false,
        zoomToBoundsOnClick: false,
        maxClusterRadius: 60,
        disableClusteringAtZoom: 17,
      });

      markers.on("clusterclick", (a) => a.layer.spiderfy());

      const todosPostes = [];
      const empresasContagem = {};

      fetch("/api/postes")
        .then((res) => res.json())
        .then((data) => {
          const agrupado = {};
          data.forEach((poste) => {
            if (!poste.coordenadas) return;
            const [lat, lon] = poste.coordenadas.split(",").map(Number);
            if (isNaN(lat) || isNaN(lon)) return;
            const key = poste.id_poste;
            if (!agrupado[key]) {
              agrupado[key] = {
                id_poste: poste.id_poste,
                resumo: poste.resumo,
                nome_municipio: poste.nome_municipio,
                coordenadas: poste.coordenadas,
                empresas: new Set(),
                lat,
                lon,
              };
            }
            agrupado[key].empresas.add(poste.empresa);
          });

          Object.values(agrupado).forEach((poste) => {
            const empresasArray = [...poste.empresas];
            empresasArray.forEach((empresa) => {
              empresasContagem[empresa] = (empresasContagem[empresa] || 0) + 1;
            });

            const qtdEmpresas = empresasArray.length;
            const cor = qtdEmpresas >= 5 ? "red" : "green";

            const icone = L.divIcon({
              className: "",
              html: `<div style="width:14px;height:14px;border-radius:50%;background:${cor};border:2px solid white;"></div>`,
              iconSize: [16, 16],
              iconAnchor: [8, 8],
            });

            const listaEmpresas = empresasArray.map((e) => `<li>${e}</li>`).join("");
            const marker = L.marker([poste.lat, poste.lon], { icon: icone });
            marker.bindPopup(
              `<b>ID do Poste:</b> ${poste.id_poste}<br><b>Empresas:</b><ul>${listaEmpresas}</ul>`
            );
            marker.bindTooltip(`ID: ${poste.id_poste} ‚Ä¢ ${qtdEmpresas} empresa(s)`, {
              direction: "top",
            });

            markers.addLayer(marker);
            todosPostes.push({ ...poste, empresas: empresasArray });
          });

          map.addLayer(markers);
          preencherAutocomplete();
        });

      function preencherAutocomplete() {
        const lista = document.getElementById("lista-empresas");
        lista.innerHTML = "";
        Object.keys(empresasContagem)
          .sort()
          .forEach((empresa) => {
            const option = document.createElement("option");
            option.value = empresa;
            option.label = `${empresa} (${empresasContagem[empresa]} postes)`;
            lista.appendChild(option);
          });
      }

      function buscarID() {
        const id = document.getElementById("busca-id").value.trim();
        const resultado = todosPostes.find((p) => p.id_poste.toString() === id);
        if (resultado) {
          map.setView([resultado.lat, resultado.lon], 18);
          const listaEmpresas = resultado.empresas.map((e) => `<li>${e}</li>`).join("");
          L.popup()
            .setLatLng([resultado.lat, resultado.lon])
            .setContent(
              `<b>ID:</b> ${resultado.id_poste}<br><b>Empresas:</b><ul>${listaEmpresas}</ul>`
            )
            .openOn(map);
        } else {
          alert("Poste n√£o encontrado.");
        }
      }

      function buscarCoordenada() {
        const coordInput = document.getElementById("busca-coord").value.trim();
        const partes = coordInput.split(",");
        if (partes.length !== 2) return alert("Use o formato: lat,lon");
        const lat = parseFloat(partes[0]);
        const lon = parseFloat(partes[1]);
        if (isNaN(lat) || isNaN(lon)) return alert("Coordenadas inv√°lidas.");

        map.setView([lat, lon], 18);
        L.popup().setLatLng([lat, lon]).setContent(`<b>Coordenada:</b><br>${lat}, ${lon}`).openOn(map);
      }

      function filtrarEmpresa() {
        const termo = document.getElementById("filtro-empresa").value.trim().toLowerCase();
        if (!termo) return;
        markers.clearLayers();
        todosPostes.forEach((poste) => {
          const empresasString = poste.empresas.join(", ").toLowerCase();
          if (!empresasString.includes(termo)) return;
          const qtdEmpresas = poste.empresas.length;
          const cor = qtdEmpresas >= 5 ? "red" : "green";
          const icone = L.divIcon({
            className: "",
            html: `<div style="width:14px;height:14px;border-radius:50%;background:${cor};border:2px solid white;"></div>`,
            iconSize: [16, 16],
            iconAnchor: [8, 8],
          });
          const listaEmpresas = poste.empresas.map((e) => `<li>${e}</li>`).join("");
          const marker = L.marker([poste.lat, poste.lon], { icon: icone });
          marker.bindPopup(`<b>ID do Poste:</b> ${poste.id_poste}<br><b>Empresas:</b><ul>${listaEmpresas}</ul>`);
          marker.bindTooltip(`ID: ${poste.id_poste} ‚Ä¢ ${qtdEmpresas} empresa(s)`, { direction: "top" });
          markers.addLayer(marker);
        });
      }

      function resetarMapa() {
        markers.clearLayers();
        todosPostes.forEach((poste) => {
          const qtdEmpresas = poste.empresas.length;
          const cor = qtdEmpresas >= 5 ? "red" : "green";
          const icone = L.divIcon({
            className: "",
            html: `<div style="width:14px;height:14px;border-radius:50%;background:${cor};border:2px solid white;"></div>`,
            iconSize: [16, 16],
            iconAnchor: [8, 8],
          });
          const listaEmpresas = poste.empresas.map((e) => `<li>${e}</li>`).join("");
          const marker = L.marker([poste.lat, poste.lon], { icon: icone });
          marker.bindPopup(`<b>ID do Poste:</b> ${poste.id_poste}<br><b>Empresas:</b><ul>${listaEmpresas}</ul>`);
          marker.bindTooltip(`ID: ${poste.id_poste} ‚Ä¢ ${qtdEmpresas} empresa(s)`, { direction: "top" });
          markers.addLayer(marker);
        });
      }

      // Bot√£o de esconder painel
      document.getElementById("togglePainel").addEventListener("click", () => {
        const painel = document.getElementById("painelBusca");
        if (painel.style.display === "none") {
          painel.style.display = "block";
          document.getElementById("togglePainel").textContent = "üôà Esconder Painel";
        } else {
          painel.style.display = "none";
          document.getElementById("togglePainel").textContent = "üëÅÔ∏è Mostrar Painel";
        }
      });

      // Bot√£o de localiza√ß√£o
      document.getElementById("localizacaoUsuario").addEventListener("click", () => {
        if (!navigator.geolocation) {
          alert("Geolocaliza√ß√£o n√£o suportada pelo navegador.");
          return;
        }
        navigator.geolocation.getCurrentPosition(
          (pos) => {
            const { latitude, longitude } = pos.coords;
            map.setView([latitude, longitude], 17);
            L.marker([latitude, longitude])
              .addTo(map)
              .bindPopup("üìç Voc√™ est√° aqui!")
              .openPopup();
          },
          (err) => {
            alert("Erro ao buscar localiza√ß√£o: " + err.message);
          }
        );
      });
    </script>
  </body>
</html>
